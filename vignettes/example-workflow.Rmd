---
title: "Running simulations"
output: rmarkdown::html_vignette
#output: pdf_document
vignette: >
  %\VignetteIndexEntry{Example workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

```{r, echo = FALSE, results = "hide", message = F}
library(esqlabsR)
```

Within the `esqlabsR` framework, the simulations are run by defining and executing multiple *scenarios*. To define a scenario, create an Excel file located in `projectConfiguration$scenarioDefinitionFile` that lists the scenario name, involved individuals, application protocols, simulation time, PKML model and model parameters. 

The package includes [an example scenario](https://github.com/esqLABS/esqlabsR/blob/HEAD/tests/data/TestProject/Parameters/Scenarios.xlsx) that models the administration of a single dose of 250 mg aciclovir intravenously to an individual with a 90 ml/min estimated glomerular filtration rate. For this purpose, the eGFR parameter is stored ..., and the administration protocol is stored in ... Both these Excel configuration files are referenced in ... to complete the project configuration.

Scenarios are then executed by creating a `ScenarioConfiguration` class instance and calling a `runScenarios()` function:

```{r}
scenarioConfiguration <- ScenarioConfiguration$new(projectConfiguration)
OutputPaths <- enum(list(
  Aciclovir_PVB = "Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"
))
simulatedScenarios <- runScenarios(
  scenarioNames = c("TestScenario"),
  scenarioConfiguration = scenarioConfiguration,
  customParams = NULL, saveSimulationsToPKML = FALSE
)
```

The `runScenarios()` function relies on an `OutputPaths` variable being defined in the current environment. The variable is expected to contain [references to an entity](https://docs.open-systems-pharmacology.org/working-with-mobi/mobi-documentation/model-building-components) that will be used as an output variable for the simulation.

The `runScenarios()` function returns a named list of lists with `Simulation` class instances, `SimulationResults` class instances, and vectors of output values.

More detailed information on function signatures can be found in:

* `esqlabsR` documentation on:
    * [ProjectConfiguration class](https://esqlabs.github.io/esqlabsR/reference/ProjectConfiguration.html)
    * [ScenarioConfiguration class](https://esqlabs.github.io/esqlabsR/reference/ScenarioConfiguration.html)
    * [readScenarioConfigurationFromExcel()](https://esqlabs.github.io/esqlabsR/reference/readScenarioConfigurationFromExcel.html)
    * [runScenarios()](https://esqlabs.github.io/esqlabsR/reference/runScenarios.html)
    
* `ospsuite` documentation on:
    * [Simulation class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/Simulation.html)
    * [SimulationResults class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/SimulationResults.html)
